# ü§ù Guia de Contribui√ß√£o - Finance AI

Obrigado por considerar contribuir para o Finance AI! Este documento cont√©m diretrizes para garantir qualidade e consist√™ncia no c√≥digo.

---

## üìã √çndice

1. [C√≥digo de Conduta](#c√≥digo-de-conduta)
2. [Como Contribuir](#como-contribuir)
3. [Padr√µes de Branch](#padr√µes-de-branch)
4. [Conven√ß√£o de Commits](#conven√ß√£o-de-commits)
5. [Pull Requests](#pull-requests)
6. [Padr√µes de C√≥digo](#padr√µes-de-c√≥digo)
7. [Arquitetura e Organiza√ß√£o](#arquitetura-e-organiza√ß√£o)

---

## üåü C√≥digo de Conduta

Este projeto segue o [Contributor Covenant](https://www.contributor-covenant.org/). Esperamos que todos os contribuidores:

- Sejam respeitosos e inclusivos
- Aceitem cr√≠ticas construtivas
- Priorizem o bem do projeto
- Demonstrem empatia com outros membros

---

## üöÄ Como Contribuir

### 1. Fork e Clone

```bash
# Fork o reposit√≥rio no GitHub
# Clone seu fork localmente
git clone https://github.com/seu-usuario/finance-ai.git
cd finance-ai

# Adicione o reposit√≥rio original como upstream
git remote add upstream https://github.com/finance-ai/finance-ai.git
```

### 2. Mantenha-se Atualizado

```bash
git fetch upstream
git checkout main
git merge upstream/main
```

### 3. Crie uma Branch

```bash
# Veja a se√ß√£o "Padr√µes de Branch" abaixo
git checkout -b feat/FIN-123-adicionar-filtro-transacoes
```

### 4. Fa√ßa suas Altera√ß√µes

Siga os [Padr√µes de C√≥digo](#padr√µes-de-c√≥digo) e [Arquitetura](#arquitetura-e-organiza√ß√£o).

### 5. Commit com Conven√ß√£o

```bash
git add .
git commit -m "feat(transactions): adicionar filtro por categoria [FIN-123]"
```

### 6. Push e Abra PR

```bash
git push origin feat/FIN-123-adicionar-filtro-transacoes
# Abra um Pull Request no GitHub
```

---

## üåø Padr√µes de Branch

### Nomenclatura

```
<tipo>/<ISSUE_ID>-<descricao-curta>
```

### Tipos de Branch

| Tipo       | Descri√ß√£o                          | Exemplo                                      |
|------------|------------------------------------|----------------------------------------------|
| `feat/`    | Nova funcionalidade                | `feat/FIN-042-sistema-pontos`                |
| `fix/`     | Corre√ß√£o de bug                    | `fix/FIN-089-saldo-negativo`                 |
| `refactor/`| Refatora√ß√£o sem mudar comportamento| `refactor/FIN-101-repository-pattern`        |
| `docs/`    | Documenta√ß√£o                       | `docs/FIN-012-adr-arquitetura`               |
| `test/`    | Adi√ß√£o/corre√ß√£o de testes          | `test/FIN-078-transaction-service`           |
| `chore/`   | Manuten√ß√£o/configura√ß√£o            | `chore/FIN-055-update-deps`                  |
| `perf/`    | Melhoria de performance            | `perf/FIN-091-otimizar-query-firestore`      |
| `style/`   | Formata√ß√£o/estilo (sem l√≥gica)     | `style/FIN-066-prettier-config`              |

### Regras

- ‚úÖ Sempre prefixar com tipo (`feat/`, `fix/`, etc.)
- ‚úÖ Incluir ID da issue/ticket quando dispon√≠vel
- ‚úÖ Usar kebab-case para descri√ß√£o
- ‚úÖ Descri√ß√£o curta e objetiva (m√°x. 50 caracteres)
- ‚ùå Nunca commitar direto na `main`

### Exemplos

```bash
# ‚úÖ Bom
git checkout -b feat/FIN-123-adicionar-filtro-transacoes
git checkout -b fix/FIN-456-corrigir-calculo-saldo
git checkout -b docs/FIN-789-documentar-ai-tools

# ‚ùå Ruim
git checkout -b nova-feature
git checkout -b fix
git checkout -b transacoes
```

---

## üí¨ Conven√ß√£o de Commits

Seguimos o padr√£o **Conventional Commits** com prefixo de issue.

### Formato

```
<tipo>(<escopo>): <descri√ß√£o> [ISSUE_ID]

<corpo opcional>

<rodap√© opcional>
```

### Tipos de Commit

| Tipo       | Descri√ß√£o                                  |
|------------|--------------------------------------------|
| `feat`     | Nova funcionalidade                        |
| `fix`      | Corre√ß√£o de bug                            |
| `refactor` | Refatora√ß√£o (sem mudar comportamento)      |
| `docs`     | Documenta√ß√£o                               |
| `test`     | Testes                                     |
| `chore`    | Manuten√ß√£o/configura√ß√£o                    |
| `perf`     | Melhoria de performance                    |
| `style`    | Formata√ß√£o/estilo                          |
| `build`    | Build system/dependencies                  |
| `ci`       | Configura√ß√£o de CI/CD                      |
| `revert`   | Reverter commit anterior                   |

### Escopos Comuns

- `accounts` - Contas banc√°rias
- `transactions` - Transa√ß√µes
- `budgets` - Or√ßamentos
- `investments` - Investimentos
- `ai` - Integra√ß√£o com IA
- `points` - Sistema de pontos
- `auth` - Autentica√ß√£o
- `ui` - Interface do usu√°rio
- `api` - API/backend
- `db` - Database/Firestore

### Regras

- ‚úÖ Primeira linha: m√°ximo 72 caracteres
- ‚úÖ Tipo em lowercase
- ‚úÖ Descri√ß√£o no imperativo ("adicionar", n√£o "adicionado")
- ‚úÖ Incluir ID da issue no final entre colchetes
- ‚úÖ Corpo opcional: explicar **o qu√™** e **por qu√™**, n√£o **como**
- ‚ùå N√£o usar ponto final na descri√ß√£o

### Exemplos

#### Commit Simples

```bash
git commit -m "feat(transactions): adicionar filtro por categoria [FIN-123]"
```

#### Commit com Corpo

```bash
git commit -m "refactor(repositories): implementar repository pattern [FIN-101]

Substituir acesso direto ao Firestore por repositories.
Isso facilita testes e futura migra√ß√£o para PostgreSQL.

M√≥dulos afetados:
- accounts
- transactions
- budgets"
```

#### Commit de Breaking Change

```bash
git commit -m "feat(api): alterar formato de resposta da API [FIN-202]

BREAKING CHANGE: O campo 'createdAt' agora retorna ISO string ao inv√©s de timestamp Unix.

Antes: { createdAt: 1698765432 }
Depois: { createdAt: '2025-10-31T10:30:00Z' }"
```

#### Outros Exemplos

```bash
# Feature
feat(budgets): adicionar alertas de or√ßamento excedido [FIN-345]

# Bug fix
fix(transactions): corrigir c√°lculo de saldo negativo [FIN-456]

# Documenta√ß√£o
docs(core): adicionar ADR sobre escolha de banco de dados [FIN-012]

# Refatora√ß√£o
refactor(ai): extrair sanitizer para m√≥dulo separado [FIN-567]

# Testes
test(investments): adicionar testes unit√°rios para calculateROI [FIN-678]

# Performance
perf(transactions): otimizar query de listagem por √≠ndice composto [FIN-789]

# Chore
chore(deps): atualizar depend√™ncias do Next.js para 15.0.2 [FIN-890]
```

---

## üîÄ Pull Requests

### Antes de Abrir um PR

- [ ] C√≥digo segue os [Padr√µes de C√≥digo](#padr√µes-de-c√≥digo)
- [ ] Commits seguem a [Conven√ß√£o de Commits](#conven√ß√£o-de-commits)
- [ ] Testes passam localmente (`npm test`)
- [ ] Build de produ√ß√£o funciona (`npm run build`)
- [ ] C√≥digo est√° formatado (`npm run lint`)
- [ ] Documenta√ß√£o atualizada (se aplic√°vel)

### T√≠tulo do PR

Siga o mesmo formato dos commits:

```
<tipo>(<escopo>): <descri√ß√£o> [ISSUE_ID]
```

**Exemplo:**
```
feat(transactions): adicionar filtro por categoria e data [FIN-123]
```

### Descri√ß√£o do PR

Use o template abaixo:

```markdown
## üìã Descri√ß√£o

Breve descri√ß√£o do que foi feito e por qu√™.

## üéØ Issue Relacionada

Closes #123

## üîÑ Tipo de Mudan√ßa

- [ ] üêõ Bug fix (corre√ß√£o de problema)
- [ ] ‚ú® Nova feature (adiciona funcionalidade)
- [ ] üí• Breaking change (altera comportamento existente)
- [ ] üìù Documenta√ß√£o
- [ ] ‚ôªÔ∏è Refatora√ß√£o
- [ ] ‚ö° Performance
- [ ] ‚úÖ Testes

## üß™ Como Testar

Passos para reproduzir e validar:

1. ...
2. ...
3. ...

## üì∏ Screenshots (se aplic√°vel)

_Adicione screenshots/gifs de mudan√ßas visuais_

## ‚úÖ Checklist

- [ ] C√≥digo segue padr√µes do projeto
- [ ] Commits seguem conven√ß√£o
- [ ] Testes adicionados/atualizados
- [ ] Documenta√ß√£o atualizada
- [ ] Build passa sem erros
- [ ] Sem warnings de lint
```

### Code Review

**Para revisores:**

- ‚úÖ Verificar se segue arquitetura de dom√≠nios
- ‚úÖ Validar que l√≥gica est√° em `services/`, n√£o na UI
- ‚úÖ Garantir uso de Zod para valida√ß√µes
- ‚úÖ Checar se c√≥digo √© SSR Safe
- ‚úÖ Validar testes (quando aplic√°vel)
- ‚úÖ Sugerir melhorias de forma construtiva

**Para autores:**

- üôè Aceite cr√≠ticas construtivas
- üîÑ Responda coment√°rios rapidamente
- üí¨ Explique decis√µes quando questionado
- ‚úèÔ∏è Fa√ßa altera√ß√µes solicitadas

---

## üé® Padr√µes de C√≥digo

### TypeScript

- ‚úÖ **Strict mode habilitado** (sem `any`, use `unknown` se necess√°rio)
- ‚úÖ **Interfaces para objetos p√∫blicos**, `type` para unions/helpers
- ‚úÖ **Nomes descritivos** (`getUserTransactions`, n√£o `getTrans`)
- ‚ùå **Sem `as any`** ou `@ts-ignore` sem justificativa

### Formata√ß√£o

```bash
# Formatar c√≥digo
npm run lint

# Verificar formata√ß√£o
npm run lint:check
```

### Nomenclatura

| Tipo            | Conven√ß√£o       | Exemplo                        |
|-----------------|-----------------|--------------------------------|
| Vari√°veis       | camelCase       | `totalBalance`, `userId`       |
| Constantes      | UPPER_SNAKE     | `MAX_TRANSACTIONS`, `API_URL`  |
| Fun√ß√µes         | camelCase       | `calculateBalance()`           |
| Classes         | PascalCase      | `TransactionService`           |
| Interfaces      | PascalCase + I  | `ITransactionRepository`       |
| Types           | PascalCase      | `CreateTransactionDTO`         |
| Enums           | PascalCase      | `TransactionType`              |
| Arquivos        | kebab-case      | `transaction-service.ts`       |

### Importa√ß√µes

```typescript
// 1. Depend√™ncias externas
import { z } from 'zod';
import { NextResponse } from 'next/server';

// 2. M√≥dulos internos (dom√≠nios)
import { transactionService } from '@/domain/transactions';
import { accountRepository } from '@/domain/accounts';

// 3. Componentes e utils
import { Button } from '@/components/ui/button';
import { formatCurrency } from '@/utils/format';

// 4. Tipos
import type { Transaction } from '@/types/transaction';
```

### Coment√°rios

```typescript
// ‚úÖ Bom: explica "por qu√™", n√£o "o qu√™"
// Usar Set para evitar duplicatas em O(1)
const uniqueIds = new Set(transactionIds);

// ‚ùå Ruim: √≥bvio e redundante
// Criar um Set com os IDs
const uniqueIds = new Set(transactionIds);

// ‚úÖ Bom: JSDoc para fun√ß√µes p√∫blicas
/**
 * Calcula o saldo total de uma conta ap√≥s uma transa√ß√£o.
 * @param accountId - ID da conta
 * @param transactionAmount - Valor da transa√ß√£o (positivo ou negativo)
 * @returns Novo saldo da conta
 * @throws {DomainError} Se conta n√£o existir
 */
export async function calculateBalance(
  accountId: string,
  transactionAmount: number
): Promise<number> {
  // ...
}
```

---

## üèóÔ∏è Arquitetura e Organiza√ß√£o

### Princ√≠pios Fundamentais

1. **Domain Modules**: Organizar por dom√≠nio, n√£o por tipo t√©cnico
2. **Repository Pattern**: Nunca acessar Firestore diretamente
3. **SSR Safe**: Sem `window`, `document`, `localStorage` em dom√≠nios
4. **Zod Everywhere**: Validar todas as entradas externas
5. **Clean Architecture**: L√≥gica de neg√≥cio apenas em `services/`

### Estrutura de um Dom√≠nio

```
domain/transactions/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ create-transaction.dto.ts    # DTOs de entrada
‚îÇ   ‚îî‚îÄ‚îÄ transaction-response.dto.ts  # DTOs de sa√≠da
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îú‚îÄ‚îÄ transaction.schema.ts        # Schemas Zod
‚îÇ   ‚îî‚îÄ‚îÄ filters.schema.ts
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ transaction.service.ts       # Regras de neg√≥cio
‚îú‚îÄ‚îÄ repositories/
‚îÇ   ‚îî‚îÄ‚îÄ transaction.repository.ts    # Acesso a dados
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ route.ts                     # Adaptador HTTP (Next.js)
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ transaction.types.ts         # Tipos TypeScript
‚îî‚îÄ‚îÄ index.ts                         # API p√∫blica do m√≥dulo
```

### Onde Colocar Cada Tipo de C√≥digo

| Tipo de C√≥digo               | Onde Colocar                          |
|------------------------------|---------------------------------------|
| Valida√ß√£o de entrada         | `schemas/` (Zod)                      |
| Regras de neg√≥cio            | `services/`                           |
| Acesso ao Firestore          | `repositories/`                       |
| Adaptador HTTP               | `api/` (Next.js Route Handler)        |
| Componente React             | `components/` (fora do dom√≠nio)       |
| Fun√ß√£o utilit√°ria            | `utils/` (se global) ou `domain/utils` |
| Constantes                   | `domain/<nome>/constants.ts`          |
| Erros customizados           | `domain/<nome>/errors.ts`             |

### Exemplo Pr√°tico: Criar Nova Transa√ß√£o

‚ùå **ERRADO** (l√≥gica na API):

```typescript
// app/api/transactions/route.ts
export async function POST(req: Request) {
  const data = await req.json();
  
  // ‚ùå Valida√ß√£o manual
  if (!data.amount || data.amount <= 0) {
    return NextResponse.json({ error: 'Invalid amount' }, { status: 400 });
  }
  
  // ‚ùå Acesso direto ao Firestore
  const account = await db.collection('accounts').doc(data.accountId).get();
  
  // ‚ùå L√≥gica de neg√≥cio na API
  account.balance += data.amount;
  await account.update({ balance: account.balance });
  
  return NextResponse.json({ success: true });
}
```

‚úÖ **CORRETO** (seguindo arquitetura):

```typescript
// domain/transactions/schemas/transaction.schema.ts
export const createTransactionSchema = z.object({
  amount: z.number().positive(),
  type: z.enum(['INCOME', 'EXPENSE']),
  accountId: z.string().uuid(),
  category: z.string().min(1),
});

// domain/transactions/services/transaction.service.ts
export class TransactionService {
  async create(userId: string, dto: CreateTransactionDTO): Promise<Transaction> {
    // Valida√ß√£o j√° feita via Zod
    const account = await accountRepository.findById(dto.accountId, userId);
    
    if (!account) {
      throw new DomainError('ACCOUNT_NOT_FOUND', 'Conta n√£o encontrada');
    }
    
    const transaction = await transactionRepository.create({
      ...dto,
      userId,
      createdAt: new Date(),
    });
    
    // Atualizar saldo
    await accountService.updateBalance(
      dto.accountId,
      dto.type === 'INCOME' ? dto.amount : -dto.amount
    );
    
    return transaction;
  }
}

// app/api/transactions/route.ts
export async function POST(req: Request) {
  try {
    const session = await getServerSession(authOptions);
    if (!session) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }
    
    const body = await req.json();
    const data = createTransactionSchema.parse(body); // ‚úÖ Valida√ß√£o Zod
    
    const transaction = await transactionService.create(session.user.id, data);
    
    return NextResponse.json(transaction);
  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: error.errors }, { status: 400 });
    }
    if (error instanceof DomainError) {
      return NextResponse.json({ error: error.message }, { status: 400 });
    }
    return NextResponse.json({ error: 'Internal error' }, { status: 500 });
  }
}
```

### Regras de Importa√ß√£o entre Dom√≠nios

- ‚úÖ **Domain ‚Üí Domain** (se exportado via `index.ts`)
- ‚úÖ **API ‚Üí Domain**
- ‚úÖ **UI ‚Üí Domain** (apenas fun√ß√µes exportadas)
- ‚ùå **Domain ‚Üí UI** (dom√≠nio n√£o conhece UI)
- ‚ùå **Repository ‚Üí Service** (apenas Service ‚Üí Repository)

### SSR Safe: O Que Evitar

```typescript
// ‚ùå NUNCA em arquivos de dom√≠nio
if (typeof window !== 'undefined') { ... }
localStorage.setItem('key', 'value')
document.querySelector('#id')
window.location.href = '/path'

// ‚úÖ Use apenas em componentes Client:
'use client'
import { useEffect, useState } from 'react'
```

---

## üß™ Testes

### Estrutura

```
domain/transactions/
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ transaction.service.ts
‚îî‚îÄ‚îÄ __tests__/
    ‚îî‚îÄ‚îÄ transaction.service.test.ts
```

### Executar Testes

```bash
# Todos os testes
npm test

# Watch mode
npm test -- --watch

# Coverage
npm test -- --coverage
```

### Exemplo de Teste

```typescript
// domain/transactions/__tests__/transaction.service.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { transactionService } from '../services/transaction.service';
import { DomainError } from '@/domain/shared/errors';

describe('TransactionService', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('create', () => {
    it('deve criar transa√ß√£o e atualizar saldo', async () => {
      const dto = {
        amount: 100,
        type: 'INCOME' as const,
        accountId: 'account-123',
        category: 'Sal√°rio',
      };

      const result = await transactionService.create('user-123', dto);

      expect(result).toMatchObject({
        amount: 100,
        type: 'INCOME',
        userId: 'user-123',
      });
    });

    it('deve lan√ßar erro se conta n√£o existir', async () => {
      const dto = {
        amount: 100,
        type: 'INCOME' as const,
        accountId: 'invalid-account',
        category: 'Sal√°rio',
      };

      await expect(
        transactionService.create('user-123', dto)
      ).rejects.toThrow(DomainError);
    });
  });
});
```

---

## üìö Recursos Adicionais

- [Documenta√ß√£o do Next.js](https://nextjs.org/docs)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/handbook/intro.html)
- [Zod Documentation](https://zod.dev/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Clean Architecture (Uncle Bob)](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

**Obrigado por contribuir! üöÄ**